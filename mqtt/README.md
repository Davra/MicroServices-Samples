# MQTT Microservice sample

To be able to receive MQTT messages in the platform we need to set up two microservices:  
1. MQTT Broker. This will run an out-of-the-box MQTT broker, e.g. mosquitto. The devices will send messages to this service.
2. MATT Client. This service will listen for new messages and process them in order to get the data into the platform.
## Broker

To set up a broker we need to create a new microservice and deploy it.  
Once deployed, the API can be used to update its docker image  
For example, to use mosquitto:

```
curl -X PATCH 'http://{TENANT}.davra.com/api/v1/microservices/{MICROSERVICE_UUID}' \
--header 'Authorization: Bearer {AUTH_TOKEN}' \
--header 'Content-Type: application/json' \
--data-raw '{
    "config.dockerImage": "registry.hub.docker.com/library/eclipse-mosquitto:1.6"
}'
```

Now to enable direct access to the microservice we add a TCP route with microservice port set to 1883.  
We copy the url and port of the new route to use when setting up the client.

### Authentication
If authentication is required then we need to extend the mosquitto docker image and use a custom configuration file.
There is a sample Dockerfile named `MosquittoConfigDockerfile_PasswordProtected.example` 
in this repository and a config file named `mosquitto_password_protected.conf`. There is 
also a sample password file who's contents should be generated by your machine's 
`mosquitto_passwd` utility with the following command(s):
```
touch mosquitto.passwd
mosquitto_passwd -b myusername mypassword
```
> If you are on a Debian machine, you can easily install `mosquitto_passwd` with `apt`.  

If you then open the password file, you should see the username followed by a ":" then a 
long has string of the password.

Once the microservice is deployed with the custom Dockerfile and config we need to create a (secret)[https://www.developer.davra.com/api/#secrets] with the content of the password file used on the config and mount it to the microservice at /etc/secrets/password (or the path you specified in the config file). 

## Client

Create a new microservice and use the files on the `client` directory of this repo (`index.js` and `package.json`)  
Replace the `MQTT_BROKER` variable value with the url and port of the broker microservice.  
Replace the `TOPIC_NAME` variable value with the topic to use.  
Open the terminal and run `npm start`  

To test it we can use a client like [this one](http://mqtt-explorer.com/)  
Publish a message to the topic used before and you should see it being logged on the console.
